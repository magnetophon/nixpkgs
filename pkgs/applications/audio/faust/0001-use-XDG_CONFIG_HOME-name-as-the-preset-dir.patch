From d311418897f8791bdffbf2103de00efe83fc79f9 Mon Sep 17 00:00:00 2001
From: Bart Brouns <bart@magnetophon.nl>
Date: Thu, 18 May 2023 17:24:28 +0200
Subject: [PATCH] use XDG_CONFIG_HOME/name as the preset dir

---
 architecture/jack-qt.cpp     | 37 ++++++++++++++++++++++++++++++++++--
 tools/faust2appls/faust2jaqt |  2 ++
 2 files changed, 37 insertions(+), 2 deletions(-)

diff --git a/architecture/jack-qt.cpp b/architecture/jack-qt.cpp
index 5d1a67ba3..95c9b4c6e 100644
--- a/architecture/jack-qt.cpp
+++ b/architecture/jack-qt.cpp
@@ -36,6 +36,14 @@
 #include <iostream>
 #include <list>
 
+#if __cplusplus < 201703L // If the version of C++ is less than 17
+#include <experimental/filesystem>
+namespace fs = std::experimental::filesystem;
+#else
+#include <filesystem>
+namespace fs = std::filesystem;
+#endif
+
 #include "faust/dsp/timed-dsp.h"
 #include "faust/gui/FUI.h"
 #include "faust/gui/JSONUI.h"
@@ -105,6 +113,24 @@ ztimedmap GUI::gTimedZoneMap;
  *******************************************************************************
  *******************************************************************************/
 
+const char* get_preset_dir() {
+    const char* preset_dir = getenv("PRESETDIR");
+    if (!preset_dir) {
+        preset_dir = getenv("XDG_CONFIG_HOME");
+        if (!preset_dir) {
+            preset_dir = getenv("HOME");
+            if (preset_dir) {
+                static char buf[PATH_MAX];
+                snprintf(buf, sizeof(buf), "%s/.config", preset_dir);
+                preset_dir = buf;
+            } else {
+                preset_dir = "/var/tmp";
+            }
+        }
+    }
+    return preset_dir;
+}
+
 int main(int argc, char* argv[])
 {
     char name[256];
@@ -181,14 +207,21 @@ int main(int argc, char* argv[])
     QTGUI* interface = new QTGUI();
     FUI finterface;
     
+
+    const char* preset_dir = get_preset_dir();
+    fs::path preset_path(preset_dir);
+
+    // Create the directory if it doesn't exist
+    fs::create_directories(preset_path);
+
 #ifdef PRESETUI
-    PresetUI pinterface(interface, string(PRESETDIR) + string(name) + ((nvoices > 0) ? "_poly" : ""));
+    PresetUI pinterface(interface, string(preset_dir) + string(name) + "/" + ((nvoices > 0) ? "poly_" : ""));
     DSP->buildUserInterface(&pinterface);
 #else
     DSP->buildUserInterface(interface);
     DSP->buildUserInterface(&finterface);
 #endif
-    
+
 #ifdef HTTPCTRL
     httpdUI httpdinterface(name, DSP->getNumInputs(), DSP->getNumOutputs(), argc, argv);
     DSP->buildUserInterface(&httpdinterface);
diff --git a/tools/faust2appls/faust2jaqt b/tools/faust2appls/faust2jaqt
index 7c295248e..5623d1bf5 100755
--- a/tools/faust2appls/faust2jaqt
+++ b/tools/faust2appls/faust2jaqt
@@ -13,6 +13,8 @@
 
 CXXFLAGS+=" $MYGCCFLAGS"  # So that additional CXXFLAGS can be used
 
+LDFLAGS+=" -lstdc++fs"
+
 ARCHFILE=$FAUSTARCH/jack-qt.cpp
 
 if [[ $(uname -s) != Darwin ]]; then
-- 
2.40.1

